---
title: Release Notes for v0.4.0
linktitle: Release Notes for v0.4.0
description: Release Notes for v0.4.0
draft: false
toc: true
layout: documentation-home
---
------------
Introduction
------------

The Pensando "v0.4.0" software distribution for NetApp is targeted for a FreeBSD 11.1+ based system.

This is drop targeted narrowly **only** for Integration work with NetApp Katana, 
and should **not** be considered FCS/Production ready.  

Please read/follow all the instructions for the previous Release Notes.

The *v0.4.0* release includes all the features of the *v0.3.0* release plus:

* Support for the `ionic_rdma` driver
* updated firmware for `NAPLES`
 
This code drop delivers entire RDMA functionality planned for the Netapp Katana deployment.
Transport Services:

* Reliable Connected (RC)
* Unreliable Datagram (UD)

RDMA Operations that Netapp will be using in Katana:

* Send
* Send with invalidate
* RDMA Read
* RDMA Write
* Fast Memory Registration.  Pensando supports FRWR way of creating MRs (IB_MR_TYPE_MEM_REG) in this phase. 
Arbitrary SG lists (IB_MR_TYPE_SG_GAPS) functionality is not supported in this phase.
* Local Invalidate


-------------
Documentation
-------------
The documentation directory (./PNSO/docs) contains the following:

|  Title                                                     |    Description                                                        |
|------------------------------------------------------------|-----------------------------------------------------------------------|
| NetApp_Katana_Pensando_User_Guide_version_0.2.0_FINAL.pdf  |  Product Overview, Installation, CLI Mgmt,  Product Specs, Known Bugs | 
| NAPLES_SONIC_API_User_Guide_version_0.2.0_FINAL.pdf        |  Detailed API guide for using the SONIC kernel offload driver (currently supporting compression/decompression only)  |
| SONIC_REF_GUIDE_v0.2.0.pdf                                 | doxygen generated reference guide for the SONIC offload driver        |
| Pencake_Sonic_Scalability_limits.pdf                       | Tunables and examples for the Pencake/SONIC driver                    |
| ontap_write_path_offload.txt                               | NetApp authored SONIC offload driver examples                         |
| FreeBSD_Katana_ionic_manual_0.4.0.pdf                      | IONIC Build and Installation Guide                                    |

Starting with version 0.2.0, the documentation comes included as a website for easy browsing and searching.
The only requirement is docker.
To load and run the website:

     * gzcat ./PNSO/docs/pnsodocs_docker.tar.gz | docker load
     * docker run -d -p 1313:1313 pnsodocs:latest

The website will present at [http://localhost:1313](http://localhost:1313)

------------------------------
Hardware Verification
---------------------

Verify that the Naples card has been properly installed and detected:
[ as per "Installing Naples into the Server" in the "NetApp_Katana_Pensando_User_Guide_version_0.1.0_FINAL.pdf" ]

For Data ONTAP, output from the LOADER should resemble:

```
		# show pci
                [...]
                11/0/0: unknown vendor 0x1dd8 product 0x1000 (PCI bridge)
                12/0/0: unknown vendor 0x1dd8 product 0x1001 (PCI bridge)
                12/1/0: unknown vendor 0x1dd8 product 0x1001 (PCI bridge)
                12/2/0: unknown vendor 0x1dd8 product 0x1001 (PCI bridge)
                12/3/0: unknown vendor 0x1dd8 product 0x1001 (PCI bridge)
                13/0/0: unknown vendor 0x1dd8 product 0x1002 (ethernet network)
                14/0/0: unknown vendor 0x1dd8 product 0x1002 (ethernet network)
                15/0/0: unknown vendor 0x1dd8 product 0x1004 (ethernet network)
                16/0/0: unknown vendor 0x1dd8 product 0x1007 (class 0x12, subclass 0x00)
```

For Linux | FreeBSD, output should resemble:

		# lspci -d 1dd8:
		5e:00.0 PCI bridge: Device 1dd8:1000
		5f:00.0 PCI bridge: Device 1dd8:1001
		5f:01.0 PCI bridge: Device 1dd8:1001
		5f:02.0 PCI bridge: Device 1dd8:1001
		5f:03.0 PCI bridge: Device 1dd8:1001
		60:00.0 Ethernet controller: Device 1dd8:1002
		61:00.0 Ethernet controller: Device 1dd8:1002
		62:00.0 Ethernet controller: Device 1dd8:1004
                63:00.0 Processing accelerators: Device 1dd8:1007

If `lspci` is not found, you will need to run `pkg install pciutils`.

For FreeBSD based systems, the NAPLES card requires that PCI ARI is disabled in the running kernel.
To verify:

        # sysctl hw.pci.enable_ari
        hw.pci.enable_ari: 0

If enable_ari is not set to zero, then please run the command below and reboot:

        # Disable PCI ARI
        echo hw.pci.enable_ari="0" >> /boot/loader.conf

-----------------------------
Driver Build and Installation
-----------------------------

Building Pensando drivers assumes that :

* the kernel is compiled with both COMPAT_LINUXKPI and OFED.  
* cc/gcc/make development toolkits are installed
* The FreeBSD kernel source is installed

Source files for the Pensando drivers are tracked in GitHub 
at https://github.com/pensando/external-netapp
Please email `jainvipin@pensando.io` and/or `ng-pensando-netapp-eng@netapp.com` for repo access.

1) Navigate to the top of the `ionic` source tree, which should resemble:

```
	root # ls
	build.sh        sys     clean.sh
```

If using the Dropbox bundle, `cd drivers; xz -d drivers-freebsd.tar.xz; tar xvf drivers-freebsd.tar; cd drivers-freebsd`
If using the `external-netapp` Github repo, `cd ionic`

2) To build and install the `ionic` and `ionic_rdma` drivers:

```
   # ./build.sh
   # kldload ./sys/modules/ionic/ionic.ko
   # kldload ./sys/modules/ionic_rdma/ionic_rdma.ko
```
   To verify:
  
```  
  # kldstat
  Id Refs Address            Size     Name
   1   10 0xffffffff80200000 2130790  kernel
   2    1 0xffffffff82419000 2328     ums.ko
   3    2 0xffffffff8241c000 11320    ionic.ko
   4    1 0xffffffff8242e000 139a9    ionic_rdma.ko
```

Please note that driver loads will not persist after reboot by default.
To persist after reboots, please add `ionic_load="YES"` 
and `ionic_rdma_load="YES"` in /boot/loader.conf

3) Assign an IP Addr to the `ionic` management interface (`ionic2`):

```
    # ifconfig ionic2 169.254.0.2/24
```

Please note that IP Addr assignment will not persist after reboot by default

4) To build and install the sonic acceleration drivers:

If building from the `external-netapp` repo, then `cd sonic`.
If building from the drivers-*.tar bundle, then `cd storage`.

```
   # ./freebsd_build.sh
   # kldload ./sonic.ko
```

> NB: The current Sonic driver may take up to 20 secs to load.  
> Please do not interrupt (^C) the 'kldload' ]

  To verify:

```
  # kldstat
  Id Refs Address            Size     Name
   1   10 0xffffffff80200000 2130790  kernel
   2    1 0xffffffff82419000 2328     ums.ko
   3    2 0xffffffff8241c000 11320    ionic.ko
   4    1 0xffffffff8242e000 139a9    ionic_rdma.ko
   5    1 0xffffffff82442000 2f9c0    sonic.ko
```

Please note that driver loads will not persist after reboot by default.
To persiste after reboot, please add `sonic_load="YES"` in /boot/loader.conf.

Please read the NAPLES_SONIC_API_User_Guide for programming/API details.


-----------------------------
S/W and Firmware Installation
-----------------------------

1) cp ./PNSO/bin/penctl.freebsd /usr/local/bin/penctl    (or desired directory in root's $PATH)
[ Note: penctl.linux is also provided for Linux-based systems ]

To build `penctl` from source for FreeBSD:

* git clone git@github.com:/pensando/external-netapp
* cd external-netapp/penctl/src/github.com/pensando/sw/penctl
* export GOPATH=`pwd | sed -e 's^src/github.com/pensando/sw/penctl^^'`
* GOOS=freebsd go build

To verify:

```
./penctl show firmware-version -i ionic2
```


2) `penctl system firmware-install -f ./PNSO/fw/naples_fw.tar -i ionic2`
[ Installs latest Naples firmware and automatically tags for use at next boot.  See NetApp_Katana_User_Guide for details. 
  Verify with "penctl show firmware-version -i ionic2"  and "penctl show running-firmware -i ionic2" ]

3) Reboot the server and run `penctl show running-firmware -i ionic2`, which should be referring to the latest image

For any problems updating NAPLES f/w, please email to : `ng-pensando-netapp-eng@netapp.com`


---------------------------------
SONIC Driver v0.4.0 Release Notes
---------------------------------
The Version 0.4.0 release provides for functional completeness over the previous releases.
Specifically v0.4.0 provides additional support for the following:

* Asynchronous Interrupt Service Requests
* Asynchronous Poll Service Requests
* Support for PNSO_CP_DFLAG_ZERO_PAD and PNSO_CP_DFLAG_BYPASS_ONFAIL for Compression offload
* Chained Operations in Requests:
  + Compression + per block Hash
  + Checksum per block + Compression
  + Checksum full block + Compression(Bypass on fail) + Checksum per block
  + Compression(Bypass on fail) + Checksum per block 
  + Checksum per block + Encryption + Checksum per block
  + Compression + Encryption
  + Decryption + Decompression


Known Software Defects:

* Sonic driver can take up to 20 seconds to load
* Do not reboot host or unload sonic driver in the middle of a sonic test - compression, hash, encryption using pencake.
* All the offloads are supported/tested within the `Sonic Limits`

Tested Limits:
* Max Input buffer size          :  8K
* Max batch size                 :  128
* Max queued requests per core   :  128
* Total number of requests       :  50 Million



Known Bugs and Caveats
----------------------
**Features not supported:**

1. Software support for Naples Status LED functionality is not available in this release
2. Software support for Naples Management LED functionality is not available in this release
3. Software support for Fiber transceivers not available in this release and only copper transceivers supported.
4. `penctl` limitations in release v0.4.0:
  + Software support for Naples Metrics via Penctl is not available in this release
  + Software support for Naples logs displayed from "penctl show logs" do not properly display in tabular or proper json format.
  + `penctl` global flags for output format specifying tabular (-t), yaml (-y) and json (-j) do not work properly.
5. RDMA Networking support is not provided for: DCQCN, PFC, QoS/Scheduling


**Known Software Defects:**

1. Do not reboot host or unload sonic driver in the middle of a sonic test - compression, hash, encryption using pencake.
2. penctl: FEC options do not work in FreeBSD. FEC options work with AN disabled. Certain vendors like Ixia and a few Cisco switches support FEC being turned off with AN enabled, in case of cisco 3232 we need to set speed (AN off) and that is release noted. Pensando behavior is to disable AN to change FEC
3. Software support for PFC functionality is not available in this release
4. Latency optimization for offload chains is still a work-in-progress and will be improved in next deliverable
5. When using "krping", please restrict max tx_qdepth to 1022.
6. To dump Naples RDMA h/w counters, please use "rdmactl" rather than sysctl. "rdmactl" is packaged as part of the drivers.
7  RDMA performance tuning is ongoing. This release is not yet optimized for best performance/latency. Upcoming releases will target improved performance.
8. This release supports max RDMA queue pair (QP) of 1K
9. Patch 0001 is provided on external-netapp repo for RDMA CM to pick v2 GIDs for tagged interfaces on Naples, since upstream RDMA CM always picking v1 GIDs.
   For RDMA CM with v6 address, please configure IPv6 address before v4, vice-versa. This is due to the way upsteam RDMA CM picks the GIDs.
10. Patch 0002 for RDMA CM provided on external-netapp repo to populate correct Traffic Class provided by the application.


** Errata / Fixed Bugs **
1) NIC: Rx completion RSS type is invalid(0xF) if RSS hash is enabled only for TCP IPV4/v6 packets (PS-684)

**Known Hardware Defects:**

None

----------
Contact Us
----------
For questions/issues/problems, please report to : `ng-pensando-netapp-eng@netapp.com`
       
